<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>NEXUS v13 | DIAGNOSTICS</title>
    <style>
        :root { --p: #00e1ff; --s: #ff00ff; --bg: #020202; --panel: #0d0d0d; --green: #00ff88; --red: #ff3333; }
        * { box-sizing: border-box; font-family: 'Consolas', monospace; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }

        /* Вход */
        #gate { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .gate-card { border: 1px solid var(--p); padding: 30px; background: var(--panel); text-align: center; width: 350px; border-radius: 5px; }

        .app { display: flex; height: 100vh; flex-direction: column; }
        
        header { 
            padding: 10px 20px; border-bottom: 1px solid #222; background: #000;
            display: flex; justify-content: space-between; align-items: center; font-size: 12px;
        }

        #viewport { 
            flex-grow: 1; padding: 20px; overflow-y: auto; 
            background: radial-gradient(circle at top, #0a0a0a, #000);
        }

        .bubble { margin-bottom: 20px; padding: 15px; border-left: 3px solid var(--p); background: rgba(255,255,255,0.02); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .ai-msg { border-color: var(--p); }
        .user-msg { border-color: var(--s); text-align: right; }
        .err-msg { border-color: var(--red); color: var(--red); font-size: 12px; }

        .control { padding: 20px; background: #080808; border-top: 1px solid #222; display: flex; gap: 10px; }
        input { flex-grow: 1; background: #000; border: 1px solid #333; color: #fff; padding: 12px; outline: none; border-radius: 4px; }
        button { background: var(--p); border: none; padding: 0 25px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        
        pre { background: #000; padding: 15px; border: 1px solid #222; color: var(--green); overflow-x: auto; text-align: left; }
        .diag-btn { font-size: 10px; color: #555; background: none; border: 1px solid #222; padding: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="gate">
    <div class="gate-card">
        <h2 style="color: var(--p); margin: 0 0 20px;">SYSTEM ACCESS</h2>
        <input type="password" id="pass" placeholder="PASSWORD (CREATOR)" style="width: 100%; text-align: center; margin-bottom: 15px; padding: 10px; background: #000; color: #fff; border: 1px solid #333;">
        <button onclick="boot()" style="width: 100%; height: 40px; background: var(--p); font-weight: bold; cursor: pointer;">ENTER</button>
    </div>
</div>

<div class="app">
    <header>
        <div id="st">STATUS: <span style="color: grey;">WAITING</span></div>
        <div style="color: var(--p);">NEXUS_v13_DEBUG</div>
        <button class="diag-btn" onclick="testConnection()">RUN DIAGNOSTICS</button>
    </header>

    <div id="viewport">
        <div class="bubble ai-msg">
            <b>[NEXUS]:</b> Система в работе. Если видишь ошибку сети на GitHub Pages — нажми кнопку <b>RUN DIAGNOSTICS</b> вверху и напиши мне, что там появилось.
        </div>
    </div>

    <div class="control">
        <input type="text" id="input" placeholder="Введите задачу..." onkeypress="if(event.key==='Enter') send()">
        <button onclick="send()">RUN</button>
    </div>
</div>

<script>
    const TOKEN = "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";
    let isLogged = false;

    function boot() {
        if(document.getElementById('pass').value.toUpperCase() === 'CREATOR') {
            document.getElementById('gate').style.display = 'none';
            isLogged = true;
        } else { alert("WRONG PASSWORD"); }
    }

    async function testConnection() {
        addMsg("SYSTEM", "Запуск диагностики...");
        try {
            const res = await fetch("https://api-inference.huggingface.co/models/Qwen/Qwen2.5-Coder-32B-Instruct", {
                headers: { "Authorization": `Bearer ${TOKEN}` },
                method: "POST", body: JSON.stringify({ inputs: "ping" })
            });
            const data = await res.json();
            addMsg("DIAG", `Ответ сервера: ${res.status} ${res.statusText}. Данные: ${JSON.stringify(data).substring(0, 50)}`);
        } catch (e) {
            addMsg("DIAG", `ОШИБКА FETCH: ${e.message}. Скорее всего, запрос блокируется браузером.`, "err-msg");
        }
    }

    async function send() {
        if(!isLogged) return;
        const inp = document.getElementById('input');
        const val = inp.value.trim();
        if(!val) return;

        addMsg("YOU", val, "user-msg");
        inp.value = "";
        const loader = addMsg("NEXUS", "<i>[GENERATING...]</i>");

        try {
            const response = await fetch("https://api-inference.huggingface.co/models/Qwen/Qwen2.5-Coder-32B-Instruct", {
                method: "POST",
                headers: { "Authorization": `Bearer ${TOKEN}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    inputs: `<|im_start|>system\nТы - лучший Luau программист. Пиши код и объяснения.<|im_end|>\n<|im_start|>user\n${val}<|im_end|>\n<|im_start|>assistant`,
                    parameters: { max_new_tokens: 1500, wait_for_model: true }
                })
            });

            const data = await response.json();
            loader.remove();

            if(data.error) {
                addMsg("ERROR", "ИИ занят или токен не активен. " + (data.error.message || data.error), "err-msg");
            } else {
                let text = data[0].generated_text.split('assistant').pop().trim();
                addMsg("NEXUS", text);
            }
        } catch (e) {
            loader.remove();
            addMsg("CRITICAL ERROR", `Ошибка сети: ${e.message}. Убедись, что отключил AdBlock и зашел через HTTPS.`, "err-msg");
        }
    }

    function addMsg(who, txt, cls = "ai-msg") {
        const view = document.getElementById('viewport');
        const d = document.createElement('div');
        d.className = "bubble " + cls;
        let html = txt.replace(/```lua([\s\S]*?)```/g, '<pre><code>$1</code></pre>').replace(/\n/g, '<br>');
        d.innerHTML = `<b>[${who}]:</b><br>${html}`;
        view.appendChild(d);
        view.scrollTop = view.scrollHeight;
        return d;
    }
</script>
</body>
</html>